var Component = require('hive-component');
var path = require('path');
var _DEBUG = false;

module.exports = function (apiary, callback) {
	function Layout(root) {
		function _load(cb) {
			var ll = require('loaders/layout_loader')(this);
			ll.core(apiary);
			ll.load(function () {
				cb();
			})
		}

		function _static(cb) {
			var static = this.get_config('static');
			if (static) {
				this.static = apiary.Static({}, {
					map:  static,
					root: path.resolve(this.get_config('root'), 'static')
				});
				this.static.init();
			}
			cb();
		}

		function _enlist(cb) {
			if (_DEBUG) {
				console.log('enlisting layout');
			}
			var root = this.get_config('root');
			if (!root) {
				if (_DEBUG) {
					console.log('attempting to enlist layout - no root');
				}
				root = this.component_id; // gotta have something...
			}
			this.$root = root;

			var existing_root = Layout.list.get(root);
			if (existing_root) {
				throw new Error('redundant layout for root %s', root);
			}
			if (_DEBUG) {
				console.log('putting a layout in the model');
			}
			Layout.list.put(this);
			cb();
		}

		function _emit(cb) {
			if (_DEBUG) {
				console.log('emitting layout %s', this.get_config('root'));
			}
			apiary.emit('layout', this);
			cb();
		}

		if (_DEBUG) {
			console.log('Layout: creating a layout for %s', root);
		}
		return Component({}, {
			root:       root,
			init_tasks: [
				_load,
				_enlist,
				_static,
				_emit
			]});
	}

	Layout.list = apiary.model('$layouts');
	apiary.Layout = Layout;

	callback();

}